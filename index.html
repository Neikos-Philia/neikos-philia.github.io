<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex, nofollow">
<link rel="stylesheet" href="/cf.css">
<title>管理后台</title>
<script src="https://cdn.jsdelivr.net/npm/@keeex/qrcodejs-kx@1.0.2/qrcode.min.js"></script>
</head>
<body>
    <!-- 背景内容 -->
    <iframe id="background-iframe" src="/"></iframe>

    <!-- 毛玻璃效果遮盖层 -->
    <div id="blur-overlay"></div>

    <!-- 管理后台容器 -->
    <div class="page-wrapper">
        <div class="card-container">
            <div class="success-message" id="successMsg"></div>
            <div class="error-message" id="errorMsg"></div>
            
            <div class="header">
                <div class="header-title">
                    <h1 id="pageTitle">加载中...</h1>
                </div>
                <div class="header-buttons">
                    <button class="btn btn-danger" onclick="resetConfigWithConfirm()" style="background: linear-gradient(135deg, #ef4444 0, #dc2626 100%); color: #fff;">⚠️ 重置配置</button>
                    <button class="btn btn-primary" onclick="logout()">👋 退出登录</button>
                </div>
            </div>

            <!-- 模块1: 订阅链接 -->
            <div class="module">
                <div class="module-title" onclick="toggleModule(this)">
                    📋 获取节点链接
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                    <div class="form-group">
                        <label>节点链接格式</label>
                        <div class="input-wrapper">
                            <input type="text" id="LinkURL" readonly>
                            <button class="btn btn-primary" onclick="copySubscription('LinkURL')">复制订阅</button>
                            <button class="btn btn-primary" onclick="showQRCode('LinkURL')">二维码</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>自适应订阅</label>
                        <div class="input-wrapper">
                            <input type="text" id="subLink" readonly>
                            <button class="btn btn-primary" onclick="copySubscription('subLink')">复制订阅</button>
                            <button class="btn btn-primary" onclick="showQRCode('subLink')">二维码</button>
                        </div>
                    </div>
                <div class="module-content">
                        <div class="form-group">
                            <label>Clash订阅</label>
                            <div class="input-wrapper">
                                <input type="text" id="clashLink" readonly>
                                <button class="btn btn-primary" onclick="copySubscription('clashLink')">复制订阅</button>
                                <button class="btn btn-primary" onclick="showQRCode('clashLink')">二维码</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>SingBox订阅</label>
                            <div class="input-wrapper">
                                <input type="text" id="singboxLink" readonly>
                                <button class="btn btn-primary" onclick="copySubscription('singboxLink')">复制订阅</button>
                                <button class="btn btn-primary" onclick="showQRCode('singboxLink')">二维码</button>
                            </div>
                        </div>
                </div>
            </div>

            <!-- 模块2: 编辑订阅生成 -->
            <div class="module collapsed">
                <div class="module-title" onclick="toggleModule(this)">
                    ⚡️ 优选订阅生成
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                <div class="module-content">
                
                <div class="form-group">
                    <label>优选订阅模式</label>
                    <select id="ipMode" onchange="updateIPMode()">
                        <option value="random">随机优选</option>
                        <option value="custom">自定义优选</option>
                        <option value="generator">优选订阅生成器</option>
                    </select>
                </div>

                <div id="randomIPSection" class="form-group">
                    <label>随机优选数量</label>
                    <input type="number" id="randomCount" min="1" max="999" value="16" onchange="markModified('sub')">
                </div>

                <div id="customIPSection" style="display:none" class="form-group">
                    <label>自定义优选地址</label>
                    <textarea id="customIPs" placeholder="每行一个地址，格式: IP[:端口]#备注" onchange="markModified('sub')"></textarea>
                </div>

                <div id="generatorSection" style="display:none" class="form-group">
                    <label>优选订阅生成器</label>
                    <input type="text" id="generatorURL" placeholder="示例: sub.cmliussss.net" onchange="markModified('sub')">
                </div>

                <div class="module-footer">
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="cancelEdit('sub')" disabled id="cancelSubBtn">取消</button>
                        <button class="btn btn-primary" onclick="saveSub()" disabled id="saveSubBtn">保存</button>
                    </div>
                </div>
                </div>
            </div>

            <!-- 模块3: 详细配置信息 -->
            <div class="module collapsed">
                <div class="module-title" onclick="toggleModule(this)">
                    ⚙️ 详细配置信息
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                <div class="module-content">
                
                <div class="form-group">
                    <label>订阅名称</label>
                    <input type="text" id="subName" onchange="markModified('config')">
                </div>

                <div class="form-group">
                    <label>节点域名</label>
                    <input type="text" id="nodeHost" readonly>
                </div>

                <div class="form-group">
                    <label>UUID</label>
                    <input type="text" id="nodeUUID" readonly>
                </div>

                <div class="form-group">
                    <label>节点协议</label>
                    <select id="protocol" onchange="updateProtocol(); markModified('config')">
                        <option value="vless">VLESS</option>
                        <option value="trojan">Trojan</option>
                    </select>
                </div>
                <!--- 节点配置 
                <div class="form-group">
                    <label>传输协议</label>
                    <select id="transport" onchange="markModified('config')">
                        <option value="ws">WebSocket</option>
                        <option value="xhttp">XHTTP</option>
                    </select>
                </div>
                --->
                <div class="form-group">
                    <label>跳过证书验证</label>
                    <div class="input-wrapper">
                        <div class="checkbox-group">
                            <input type="checkbox" id="skipVerify" onchange="markModified('config')">
                            <label for="skipVerify" class="checkbox-label">启用</label>
                        </div>
                    </div>
                </div>

                <div class="module-footer">
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="cancelEdit('config')" disabled id="cancelConfigBtn">取消</button>
                        <button class="btn btn-primary" onclick="saveConfig()" disabled id="saveConfigBtn">保存</button>
                    </div>
                </div>
                </div>
            </div>

            <!-- 模块4: 反代落地设置 -->
            <div class="module collapsed">
                <div class="module-title" onclick="toggleModule(this)">
                    🌐 CFCDN落地设置
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                <div class="module-content">
                
                <div class="form-group">
                    <label>反代模式</label>
                    <select id="proxyMode" onchange="updateProxyMode()">
                        <option value="auto">PROXYIP</option>
                        <option value="socks5">SOCKS5</option>
                        <option value="http">HTTP</option>
                    </select>
                </div>

                <div id="proxyIPSection" class="form-group">
                    <div class="form-group">
                        <label>PROXYIP</label>
                        <div class="input-wrapper">
                            <input type="text" id="proxyIP" placeholder="示例: proxyip.cmliussss.net" onchange="markModified('proxy')">
                            <div class="checkbox-group">
                                <input type="checkbox" id="autoProxy" onchange="toggleAutoProxy(); markModified('proxy')">
                                <label for="autoProxy" class="checkbox-label">启用自动获取</label>
                            </div>
                        </div>
                    </div>
                </div>


                <div id="socks5Section" style="display:none">
                    <div class="form-group">
                        <label>SOCKS5</label>
                        <div class="input-wrapper">
                        <input type="text" id="socks5Addr" placeholder="示例: user:password@127.0.0.1:1080" onchange="markModified('proxy')">
                            <div class="checkbox-group">
                                <input type="checkbox" id="globalSocks5" onchange="markModified('proxy')">
                                <label for="globalSocks5" class="checkbox-label">启用全局代理</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="httpSection" style="display:none">
                    <div class="form-group">
                        <label>HTTP</label>
                        <div class="input-wrapper">
                        <input type="text" id="httpAddr" placeholder="示例: user:password@127.0.0.1:1080" onchange="markModified('proxy')">
                            <div class="checkbox-group">
                                <input type="checkbox" id="globalHTTP" onchange="markModified('proxy')">
                                <label for="globalHTTP" class="checkbox-label">启用全局代理</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="module-footer">
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="cancelEdit('proxy')" disabled id="cancelProxyBtn">取消</button>
                        <button class="btn btn-primary" onclick="saveProxy()" disabled id="saveProxyBtn">保存</button>
                    </div>
                </div>
                </div>
            </div>

            <!-- 模块5: 订阅转换配置 -->
            <div class="module collapsed">
                <div class="module-title" onclick="toggleModule(this)">
                    🔄 订阅转换配置
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                <div class="module-content">
                
                <div class="form-group">
                    <label>订阅转换后端</label>
                    <div class="readonly-wrapper" onclick="openSubAPIModal()">
                        <input type="text" id="subAPI" readonly placeholder="https://SUBAPI.cmliussss.net" style="cursor: pointer; background-color: #f9fafb;">
                    </div>
                </div>

                <div class="form-group">
                    <label>订阅转换配置文件</label>
                    <input type="text" id="subConfig" placeholder="https://raw.githubusercontent.com/..." onchange="markModified('convert')">
                </div>

                <div class="form-group">
                    <label>Emoji</label>
                    <div class="input-wrapper">
                        <div class="checkbox-group">
                            <input type="checkbox" id="emoji" onchange="markModified('convert')">
                            <label for="emoji" class="checkbox-label">启用</label>
                        </div>
                    </div>
                </div>

                <div class="module-footer">
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="cancelEdit('convert')" disabled id="cancelConvertBtn">取消</button>
                        <button class="btn btn-primary" onclick="saveConvert()" disabled id="saveConvertBtn">保存</button>
                    </div>
                </div>
                </div>
            </div>

            <!-- 模块6: 查看所有日志 -->
            <div class="module collapsed">
                <div class="module-title" onclick="toggleModule(this); loadLogsOnExpand(this)">
                    📋 查看操作日志
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                <div class="module-content">
                    <div id="logsContainer" style="margin-bottom: 20px;">
                        <div style="text-align: center; padding: 20px; color: #6b7280;">加载中...</div>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: flex-end; gap: 15px; margin-top: 20px;">
                        <p style="font-size: 12px; color: #9ca3af; margin: 0;">因为KV空间有限，所以只保留4MB的操作日志，当日志大小超过该容量会自动清理最老的日志记录。</p>
                        <button class="btn btn-primary" onclick="showAllLogs()" style="background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%); flex-shrink: 0;">全部日志</button>
                    </div>
                </div>
            </div>

            <div class="social-links">
                <a href="https://github.com/cmliu/edgetunnel" target="_blank" class="social-link" title="GitHub">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                        <path fill="currentColor" fill-rule="evenodd" d="M7.976 0A7.977 7.977 0 0 0 0 7.976c0 3.522 2.3 6.507 5.431 7.584c.392.049.538-.196.538-.392v-1.37c-2.201.49-2.69-1.076-2.69-1.076c-.343-.93-.881-1.175-.881-1.175c-.734-.489.048-.489.048-.489c.783.049 1.224.832 1.224.832c.734 1.223 1.859.88 2.3.685c.048-.538.293-.88.489-1.076c-1.762-.196-3.621-.881-3.621-3.964c0-.88.293-1.566.832-2.153c-.05-.147-.343-.978.098-2.055c0 0 .685-.196 2.201.832c.636-.196 1.322-.245 2.007-.245s1.37.098 2.006.245c1.517-1.027 2.202-.832 2.202-.832c.44 1.077.146 1.908.097 2.104a3.16 3.16 0 0 1 .832 2.153c0 3.083-1.86 3.719-3.62 3.915c.293.244.538.733.538 1.467v2.202c0 .196.146.44.538.392A7.98 7.98 0 0 0 16 7.976C15.951 3.572 12.38 0 7.976 0" clip-rule="evenodd"/>
                    </svg>
                </a>
                <a href="https://t.me/CMLiussss" target="_blank" class="social-link" title="Telegram">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
                        <defs>
                            <linearGradient id="telegramGradient" x1="50%" x2="50%" y1="0%" y2="100%">
                                <stop offset="0%" stop-color="#2AABEE"/>
                                <stop offset="100%" stop-color="#229ED9"/>
                            </linearGradient>
                        </defs>
                        <path fill="url(#telegramGradient)" d="M128 0C94.06 0 61.48 13.494 37.5 37.49A128.04 128.04 0 0 0 0 128c0 33.934 13.5 66.514 37.5 90.51C61.48 242.506 94.06 256 128 256s66.52-13.494 90.5-37.49c24-23.996 37.5-56.576 37.5-90.51s-13.5-66.514-37.5-90.51C194.52 13.494 161.94 0 128 0"/>
                        <path fill="#FFF" d="M57.94 126.648q55.98-24.384 74.64-32.152c35.56-14.786 42.94-17.354 47.76-17.441c1.06-.017 3.42.245 4.96 1.49c1.28 1.05 1.64 2.47 1.82 3.467c.16.996.38 3.266.2 5.038c-1.92 20.24-10.26 69.356-14.5 92.026c-1.78 9.592-5.32 12.808-8.74 13.122c-7.44.684-13.08-4.912-20.28-9.63c-11.26-7.386-17.62-11.982-28.56-19.188c-12.64-8.328-4.44-12.906 2.76-20.386c1.88-1.958 34.64-31.748 35.26-34.45c.08-.338.16-1.598-.6-2.262c-.74-.666-1.84-.438-2.64-.258c-1.14.256-19.12 12.152-54 35.686c-5.1 3.508-9.72 5.218-13.88 5.128c-4.56-.098-13.36-2.584-19.9-4.708c-8-2.606-14.38-3.984-13.82-8.41c.28-2.304 3.46-4.662 9.52-7.072"/>
                    </svg>
                </a>
                <button class="social-link theme-toggle" id="themeToggle" title="切换夜间模式" onclick="toggleTheme()">
                    <!-- 太阳图标 (日间模式显示) -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="theme-icon sun-icon" style="display: block;">
                        <circle cx="12" cy="12" r="5" fill="currentColor"/>
                        <g stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none">
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </g>
                    </svg>
                    <!-- 月亮图标 (夜间模式显示) -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="theme-icon moon-icon" style="display: none;">
                        <path fill="currentColor" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

<!-- 二维码弹窗 -->
<div class="modal-overlay" id="qrcodeModal" onclick="closeQRCode(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeQRCode()">×</button>
        <div id="qrcodeContainer" style="margin:20px 0;display:flex;justify-content:center;align-items:center"></div>
        <button class="btn btn-primary" onclick="closeQRCode()" style="width:100%;margin-top:20px">关闭</button>
    </div>
</div>

<!-- 重置配置确认弹窗 -->
<div class="modal-overlay" id="resetModal" onclick="closeResetModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <h2 style="color:#ef4444;margin-bottom:15px">⚠️ 重置配置</h2>
        <p style="margin-bottom:20px;line-height:1.6">重置配置将会初始化所有设置，包括订阅生成、节点信息、反代配置等。此操作不可撤销，请谨慎操作。</p>
        <p style="color:#ef4444;font-weight:bold;margin-bottom:20px">确定是否完全重置配置？</p>
        <div style="display:flex;gap:10px;justify-content:space-between">
            <button class="btn btn-primary" onclick="confirmReset()" style="background: linear-gradient(135deg, #ef4444 0, #dc2626 100%); color: #fff;">确定重置</button>
            <button class="btn btn-secondary" onclick="closeResetModal()">取消重置</button>
        </div>
    </div>
</div>

<!-- 日志查看弹窗 -->
<div class="modal-overlay" id="logsModal" onclick="closeLogsModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="overflow-y: auto; width: 90vw; max-width: 1400px; margin: 0 auto;">
        <button class="modal-close" onclick="closeLogsModal()">×</button>
        <h2 style="margin-bottom: 20px;">📋 所有操作日志</h2>
        <div id="allLogsContainer" style="max-height: 70vh; overflow-y: auto; overflow-x: auto;"></div>
        <button class="btn btn-primary" onclick="closeLogsModal()" style="width:100%;margin-top:20px">关闭</button>
    </div>
</div>

<!-- 订阅转换后端设置弹窗 -->
<div class="modal-overlay" id="subAPIModal" onclick="closeSubAPIModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeSubAPIModal()">×</button>
        <h2 style="margin-bottom: 20px;">⚙️ 订阅转换后端</h2>
        <div class="form-group" style="grid-template-columns: 1fr;">
            <label>订阅转换后端地址</label>
            <input type="text" id="testSubAPIInput" placeholder="输入订阅转换后端地址">
        </div>
        <div id="subAPIStatus" style="margin: 15px 0; padding: 12px 16px; border-radius: 8px; display: none;"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-primary" onclick="testSubAPI()" style="flex: 2; background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%); color: #fff;">可用性验证</button>
            <button class="btn btn-primary" id="subAPIConfirmBtn" onclick="confirmSubAPI()" disabled style="flex: 1; opacity: 0.5;">确定</button>
            <button class="btn btn-secondary" onclick="closeSubAPIModal()" style="flex: 1;">取消</button>
        </div>
    </div>
</div>

<script>
let currentConfig = {};
let originalConfig = {};
let modifiedSections = new Set();

// 初始化主题
function initializeTheme() {
    const saved = localStorage.getItem('theme');
    let theme = saved;
    
    // 如果第一次打开，按系统主题决定
    if (!saved) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    
    applyTheme(theme);
}

// 应用主题
function applyTheme(theme) {
    if (theme === 'dark') {
        document.documentElement.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
    } else {
        document.documentElement.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
    }
}

// 切换主题
function toggleTheme() {
    const isDark = document.documentElement.classList.contains('dark-mode');
    applyTheme(isDark ? 'light' : 'dark');
}

async function loadConfig() {
    try {
    const response = await fetch('/admin/config.json?t=' + Date.now());
        if (!response.ok) throw new Error('加载配置失败');
        currentConfig = await response.json();
        originalConfig = JSON.parse(JSON.stringify(currentConfig));
        renderUI();
    } catch (error) {
        showToast('加载配置失败: ' + error.message, 'error');
    }
}

function renderUI() {
    // 标题
    document.getElementById('pageTitle').textContent = (currentConfig.优选订阅生成?.SUBNAME || 'edgetunnel') + '设置页面';
    
    // 订阅链接
    const token = currentConfig.优选订阅生成?.TOKEN;
    const host = currentConfig.HOST;
    const link = currentConfig.LINK;
    document.getElementById('LinkURL').value = currentConfig.LINK;
    document.getElementById('subLink').value = `https://${host}/sub?token=${token}`;
    document.getElementById('clashLink').value = `https://${host}/sub?token=${token}&clash`;
    document.getElementById('singboxLink').value = `https://${host}/sub?token=${token}&sb`;
    
    // 编辑订阅生成
    const local = currentConfig.优选订阅生成?.local ?? true;
    const randomIP = currentConfig.优选订阅生成?.本地IP库?.随机IP ?? true;
    
    if (!local) {
        document.getElementById('ipMode').value = 'generator';
        document.getElementById('generatorURL').value = currentConfig.优选订阅生成?.SUB || '';
    } else if (randomIP) {
        document.getElementById('ipMode').value = 'random';
        document.getElementById('randomCount').value = currentConfig.优选订阅生成?.本地IP库?.随机数量 || 16;
    } else {
        document.getElementById('ipMode').value = 'custom';
        loadCustomIPs();
    }
    updateIPMode();
    
    // 详细配置
    document.getElementById('subName').value = currentConfig.优选订阅生成?.SUBNAME || '';
    document.getElementById('nodeHost').value = currentConfig.HOST || '';
    document.getElementById('nodeUUID').value = currentConfig.UUID || '';
    document.getElementById('protocol').value = currentConfig.协议类型 || 'vless';
    //document.getElementById('transport').value = currentConfig.传输协议 || 'ws';
    document.getElementById('skipVerify').checked = currentConfig.跳过证书验证 || false;
    
    // 反代落地设置
    const socksEnabled = currentConfig.反代?.SOCKS5?.启用;
    if (!socksEnabled) {
        document.getElementById('proxyMode').value = 'auto';
        document.getElementById('proxyIP').value = currentConfig.反代?.PROXYIP || '';
        document.getElementById('autoProxy').checked = (currentConfig.反代?.PROXYIP === 'auto');
        if (currentConfig.反代?.PROXYIP === 'auto') {
            document.getElementById('proxyIP').disabled = true;
        }
    } else if (socksEnabled === 'socks5') {
        document.getElementById('proxyMode').value = 'socks5';
        document.getElementById('socks5Addr').value = currentConfig.反代?.SOCKS5?.账号 || '';
        document.getElementById('globalSocks5').checked = currentConfig.反代?.SOCKS5?.全局 || false;
    } else if (socksEnabled === 'http') {
        document.getElementById('proxyMode').value = 'http';
        document.getElementById('httpAddr').value = currentConfig.反代?.SOCKS5?.账号 || '';
        document.getElementById('globalHTTP').checked = currentConfig.反代?.SOCKS5?.全局 || false;
    }
    updateProxyMode();
    
    // 订阅转换配置
    document.getElementById('subAPI').value = currentConfig.订阅转换配置?.SUBAPI || '';
    document.getElementById('subConfig').value = currentConfig.订阅转换配置?.SUBCONFIG || '';
    document.getElementById('emoji').checked = currentConfig.订阅转换配置?.SUBEMOJI || false;
    
    modifiedSections.clear();
    resetAllButtons();
    
    // 从 localStorage 加载模块展开/折叠状态
    loadModuleStates();
}

async function loadCustomIPs() {
    const textarea = document.getElementById('customIPs');
    textarea.disabled = true;
    textarea.value = '正在加载...';
    
    try {
    const response = await fetch('/admin/ADD.txt?t=' + Date.now());
        if (response.ok) {
            textarea.value = await response.text();
        } else {
            textarea.value = '';
        }
    } catch (error) {
        showToast('加载自定义IP失败', 'error');
        textarea.value = '';
    } finally {
        textarea.disabled = false;
    }
}

function updateIPMode() {
    const mode = document.getElementById('ipMode').value;
    document.getElementById('randomIPSection').style.display = mode === 'random' ? 'grid' : 'none';
    document.getElementById('customIPSection').style.display = mode === 'custom' ? 'block' : 'none';
    document.getElementById('generatorSection').style.display = mode === 'generator' ? 'grid' : 'none';
    
    // 当切换到自定义优选时，自动加载现有的ADD.txt内容
    if (mode === 'custom') {
        loadCustomIPs();
    }
    
    markModified('sub');
}

function updateProtocol() {
    const protocol = document.getElementById('protocol').value;
    /*
    const transport = document.getElementById('transport');
    if (protocol === 'trojan') {
        transport.value = 'ws';
        transport.disabled = true;
    } else {
        transport.disabled = false;
    }
    */
}

function updateProxyMode() {
    const mode = document.getElementById('proxyMode').value;
    document.getElementById('proxyIPSection').style.display = mode === 'auto' ? 'block' : 'none';
    document.getElementById('socks5Section').style.display = mode === 'socks5' ? 'block' : 'none';
    document.getElementById('httpSection').style.display = mode === 'http' ? 'block' : 'none';
    markModified('proxy');
}

function toggleAutoProxy() {
    const autoProxy = document.getElementById('autoProxy').checked;
    document.getElementById('proxyIP').disabled = autoProxy;
    markModified('proxy');
}

function toggleModule(titleEl) {
    const module = titleEl.parentElement;
    const content = module.querySelector('.module-content');

    // If there's no collapsible content, just toggle the class
    if (!content) {
        module.classList.toggle('collapsed');
        saveModuleStates();
        return;
    }

    // If a transition is currently attached, remove it to avoid duplicate handlers
    if (content._transitionHandler) {
        content.removeEventListener('transitionend', content._transitionHandler);
        content._transitionHandler = null;
    }

    const isCollapsed = module.classList.contains('collapsed');

    if (isCollapsed) {
        // Expand
        content.style.display = 'block';
        // Measure height
        const height = content.scrollHeight;
        // Start from 0
        content.style.maxHeight = '0px';
        content.style.opacity = '0';
        // Force reflow
        content.getBoundingClientRect();
        // Animate to measured height
        content.style.maxHeight = height + 'px';
        content.style.opacity = '1';

        const onEnd = function (e) {
            if (e.propertyName === 'max-height') {
                // Clear fixed max-height so content can grow/shrink naturally
                content.style.maxHeight = '';
                content.removeEventListener('transitionend', onEnd);
                content._transitionHandler = null;
            }
        };
        content._transitionHandler = onEnd;
        content.addEventListener('transitionend', onEnd);

        module.classList.remove('collapsed');
    } else {
        // Collapse
        const height = content.scrollHeight;
        // Ensure starting height is set
        content.style.maxHeight = height + 'px';
        content.style.opacity = '1';
        // Force reflow
        content.getBoundingClientRect();
        // Animate to 0
        content.style.maxHeight = '0px';
        content.style.opacity = '0';

        const onEnd = function (e) {
            if (e.propertyName === 'max-height') {
                // Hide after collapsing to remove from tab order
                content.style.display = 'none';
                content.removeEventListener('transitionend', onEnd);
                content._transitionHandler = null;
            }
        };
        content._transitionHandler = onEnd;
        content.addEventListener('transitionend', onEnd);

        module.classList.add('collapsed');
    }
    
    // 保存模块状态到 localStorage
    saveModuleStates();
}

function markModified(section) {
    modifiedSections.add(section);
    updateButtonStates();
}

function updateButtonStates() {
    // 订阅生成模块
    const subModified = modifiedSections.has('sub');
    document.getElementById('saveSubBtn').disabled = !subModified;
    document.getElementById('cancelSubBtn').disabled = !subModified;
    
    // 配置信息模块
    const configModified = modifiedSections.has('config');
    document.getElementById('saveConfigBtn').disabled = !configModified;
    document.getElementById('cancelConfigBtn').disabled = !configModified;
    
    // 反代设置模块
    const proxyModified = modifiedSections.has('proxy');
    document.getElementById('saveProxyBtn').disabled = !proxyModified;
    document.getElementById('cancelProxyBtn').disabled = !proxyModified;
    
    // 订阅转换模块
    const convertModified = modifiedSections.has('convert');
    document.getElementById('saveConvertBtn').disabled = !convertModified;
    document.getElementById('cancelConvertBtn').disabled = !convertModified;
}

function resetAllButtons() {
    document.querySelectorAll('[id^="save"]').forEach(btn => btn.disabled = true);
    document.querySelectorAll('[id^="cancel"]').forEach(btn => btn.disabled = true);
}

function copySubscription(elementId) {
    const element = document.getElementById(elementId);
    navigator.clipboard.writeText(element.value).then(() => {
        showToast('已复制到剪贴板', 'success');
    }).catch(() => {
        showToast('复制失败', 'error');
    });
}

function showQRCode(elementId) {
    const text = document.getElementById(elementId).value;
    const container = document.getElementById('qrcodeContainer');
    container.innerHTML = '';
    new QRCode(container, {
        text: text,
        width: 200,
        height: 200,
        colorDark: '#000',
        colorLight: '#fff',
        correctLevel: QRCode.CorrectLevel.H
    });
    document.getElementById('qrcodeModal').classList.add('show');
}

function closeQRCode(event) {
    if (!event || event.target.id === 'qrcodeModal') {
        document.getElementById('qrcodeModal').classList.remove('show');
    }
}

async function saveSub() {
    const mode = document.getElementById('ipMode').value;
    const updates = {
        local: mode !== 'generator',
        本地IP库: { 随机IP: mode === 'random', 随机数量: parseInt(document.getElementById('randomCount').value) || 16 },
        SUB: mode === 'generator' ? document.getElementById('generatorURL').value : null,
        SUBNAME: currentConfig.优选订阅生成.SUBNAME,
        SUBUpdateTime: currentConfig.优选订阅生成.SUBUpdateTime,
        TOKEN: currentConfig.优选订阅生成.TOKEN
    };
    
    currentConfig.优选订阅生成 = { ...currentConfig.优选订阅生成, ...updates };
    
    if (mode === 'custom') {
        const customIPs = document.getElementById('customIPs').value;
        try {
            await fetch('/admin/ADD.txt', { method: 'POST', body: customIPs });
        } catch (error) {
            showToast('保存自定义IP失败', 'error');
            return;
        }
    }
    
    await saveConfigToServer('sub');
}

async function saveConfig() {
    currentConfig.优选订阅生成.SUBNAME = document.getElementById('subName').value;
    currentConfig.协议类型 = document.getElementById('protocol').value;
    //currentConfig.传输协议 = currentConfig.协议类型 === 'trojan' ? 'ws' : document.getElementById('transport').value;
    currentConfig.跳过证书验证 = document.getElementById('skipVerify').checked;
    
    await saveConfigToServer('config');
}

async function saveProxy() {
    const mode = document.getElementById('proxyMode').value;
    let socksEnabled = null;
    let socksAccount = '';
    let globalProxy = false;
    let proxyIP = currentConfig.反代.PROXYIP;
    
    if (mode === 'auto') {
        socksEnabled = null;
        proxyIP = document.getElementById('autoProxy').checked ? 'auto' : document.getElementById('proxyIP').value;
    } else if (mode === 'socks5') {
        socksEnabled = 'socks5';
        socksAccount = document.getElementById('socks5Addr').value;
        globalProxy = document.getElementById('globalSocks5').checked;
    } else if (mode === 'http') {
        socksEnabled = 'http';
        socksAccount = document.getElementById('httpAddr').value;
        globalProxy = document.getElementById('globalHTTP').checked;
    }
    
    currentConfig.反代 = {
        PROXYIP: proxyIP,
        SOCKS5: {
            启用: socksEnabled,
            全局: globalProxy,
            账号: socksAccount,
            白名单: currentConfig.反代.SOCKS5.白名单
        }
    };
    
    await saveConfigToServer('proxy');
}

async function saveConvert() {
    currentConfig.订阅转换配置 = {
        SUBAPI: document.getElementById('subAPI').value,
        SUBCONFIG: document.getElementById('subConfig').value,
        SUBEMOJI: document.getElementById('emoji').checked
    };
    
    await saveConfigToServer('convert');
}

async function saveConfigToServer(section) {
    try {
        const response = await fetch('/admin/config.json', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(currentConfig)
        });
        
        if (!response.ok) throw new Error('保存失败');
        showToast('配置已保存', 'success');
        modifiedSections.delete(section);
        updateButtonStates();
    } catch (error) {
        showToast('保存失败: ' + error.message, 'error');
    }
}

function cancelEdit(section) {
    currentConfig = JSON.parse(JSON.stringify(originalConfig));
    
    // 只重置该模块的值，不调用 renderUI 以保持展开状态
    if (section === 'sub') {
        const local = currentConfig.优选订阅生成?.local ?? true;
        const randomIP = currentConfig.优选订阅生成?.本地IP库?.随机IP ?? true;
        
        if (!local) {
            document.getElementById('ipMode').value = 'generator';
            document.getElementById('generatorURL').value = currentConfig.优选订阅生成?.SUB || '';
        } else if (randomIP) {
            document.getElementById('ipMode').value = 'random';
            document.getElementById('randomCount').value = currentConfig.优选订阅生成?.本地IP库?.随机数量 || 16;
        } else {
            document.getElementById('ipMode').value = 'custom';
            loadCustomIPs();
        }
        updateIPMode();
    } else if (section === 'config') {
        document.getElementById('subName').value = currentConfig.优选订阅生成?.SUBNAME || '';
        document.getElementById('nodeHost').value = currentConfig.HOST || '';
        document.getElementById('nodeUUID').value = currentConfig.UUID || '';
        document.getElementById('protocol').value = currentConfig.协议类型 || 'vless';
        document.getElementById('skipVerify').checked = currentConfig.跳过证书验证 || false;
        updateProtocol();
    } else if (section === 'proxy') {
        const socksEnabled = currentConfig.反代?.SOCKS5?.启用;
        if (!socksEnabled) {
            document.getElementById('proxyMode').value = 'auto';
            document.getElementById('proxyIP').value = currentConfig.反代?.PROXYIP || '';
            document.getElementById('autoProxy').checked = (currentConfig.反代?.PROXYIP === 'auto');
            if (currentConfig.反代?.PROXYIP === 'auto') {
                document.getElementById('proxyIP').disabled = true;
            }
        } else if (socksEnabled === 'socks5') {
            document.getElementById('proxyMode').value = 'socks5';
            document.getElementById('socks5Addr').value = currentConfig.反代?.SOCKS5?.账号 || '';
            document.getElementById('globalSocks5').checked = currentConfig.反代?.SOCKS5?.全局 || false;
        } else if (socksEnabled === 'http') {
            document.getElementById('proxyMode').value = 'http';
            document.getElementById('httpAddr').value = currentConfig.反代?.SOCKS5?.账号 || '';
            document.getElementById('globalHTTP').checked = currentConfig.反代?.SOCKS5?.全局 || false;
        }
        updateProxyMode();
    } else if (section === 'convert') {
        document.getElementById('subAPI').value = currentConfig.订阅转换配置?.SUBAPI || '';
        document.getElementById('subConfig').value = currentConfig.订阅转换配置?.SUBCONFIG || '';
        document.getElementById('emoji').checked = currentConfig.订阅转换配置?.SUBEMOJI || false;
    }
    
    modifiedSections.delete(section);
    updateButtonStates();
}

// 保存模块展开/折叠状态到 localStorage
function saveModuleStates() {
    const states = {};
    document.querySelectorAll('.module').forEach((module, index) => {
        const title = module.querySelector('.module-title')?.textContent?.trim() || ('module-' + index);
        // 不保存"查看操作日志"模块的状态
        if (title !== '📋 查看操作日志') {
            states[title] = !module.classList.contains('collapsed');
        }
    });
    localStorage.setItem('adminModuleStates', JSON.stringify(states));
}

// 从 localStorage 加载模块展开/折叠状态
function loadModuleStates() {
    const savedStates = localStorage.getItem('adminModuleStates');
    const states = savedStates ? JSON.parse(savedStates) : {};
    
    // 如果是第一次访问（localStorage中没有保存状态），所有模块默认折叠
    const isFirstVisit = !savedStates;
    
    document.querySelectorAll('.module').forEach((module, index) => {
        const title = module.querySelector('.module-title')?.textContent?.trim() || ('module-' + index);
        let shouldBeExpanded;
        
        // "查看操作日志"模块始终保持折叠状态
        if (title === '📋 查看操作日志') {
            shouldBeExpanded = false;
        } else {
            shouldBeExpanded = isFirstVisit ? false : (states[title] !== false); // 第一次默认折叠，之后按保存的状态
        }
        
        const isCurrentlyCollapsed = module.classList.contains('collapsed');
        const content = module.querySelector('.module-content');
        
        if (shouldBeExpanded && isCurrentlyCollapsed) {
            // 需要展开
            module.classList.remove('collapsed');
            if (content) {
                content.style.display = 'block';
                content.style.maxHeight = '';
                content.style.opacity = '1';
            }
        } else if (!shouldBeExpanded && !isCurrentlyCollapsed) {
            // 需要折叠
            module.classList.add('collapsed');
            if (content) {
                content.style.display = 'none';
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
            }
        }
    });
}

async function refreshConfig() {
    await loadConfig();
    const loadTime = currentConfig.加载时间 || '未知';
    showToast(`配置已刷新 (加载时间: ${loadTime})`, 'success');
}

function resetConfigWithConfirm() {
    document.getElementById('resetModal').classList.add('show');
}

function closeResetModal(event) {
    if (event && event.target.id !== 'resetModal') return;
    document.getElementById('resetModal').classList.remove('show');
}

async function confirmReset() {
    try {
        const response = await fetch('/admin/init');
        if (!response.ok) throw new Error('重置失败');
        
        closeResetModal();
        showToast('配置已重置为默认值', 'success');
        
        // 延迟1秒后刷新页面，让用户看到成功提示
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    } catch (error) {
        showToast('重置失败: ' + error.message, 'error');
    }
}

function logout() {
    window.location.href = '/logout';
}

function showToast(message, type = 'info') {
    // 移除现有的toast
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // 创建新的toast
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // 显示动画
    setTimeout(() => toast.classList.add('show'), 10);
    
    // 自动隐藏
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// 日志类型翻译
function translateLogType(type, ua = '') {
    // 如果是 Get_SUB 类型，检查 UA 是否包含 subconverter
    if (type === 'Get_SUB') {
        const uaLowercase = (ua || '').toLowerCase();
        if (uaLowercase.includes('subconverter')) {
            return { text: '订阅转换后端', color: '#3b82f6' };
        }
        return { text: '获取节点订阅', color: '#10b981' };
    }
    
    const typeMap = {
        'Admin_Login': { text: '登录管理员后台', color: '#f59e0b' },
        'Save_Config': { text: '保存配置信息', color: '#8b5cf6' },
        'Init_Config': { text: '重置配置信息', color: '#ef4444' },
        'Save_Custom_IPs': { text: '保存自定义IP', color: '#06b6d4' }
    };
    return typeMap[type] || { text: type, color: '#6b7280' };
}

// 格式化时间戳为 UTC+8
function formatTime(timestamp) {
    const date = new Date(timestamp + 8 * 3600 * 1000);
    const year = date.getUTCFullYear();
    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
    const day = String(date.getUTCDate()).padStart(2, '0');
    const hours = String(date.getUTCHours()).padStart(2, '0');
    const minutes = String(date.getUTCMinutes()).padStart(2, '0');
    const seconds = String(date.getUTCSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

// 在展开日志模块时加载日志
let logsLoaded = false;
function loadLogsOnExpand(titleEl) {
    const module = titleEl.parentElement;
    const isCollapsed = module.classList.contains('collapsed');
    
    // 如果是展开状态且还未加载过日志，则加载
    if (!isCollapsed && !logsLoaded) {
        loadLogs();
    }
}

// 加载最近6条日志
async function loadLogs() {
    try {
        const response = await fetch('/admin/log.json?t=' + Date.now());
        if (!response.ok) throw new Error('加载日志失败');
        const logs = await response.json();
        logsLoaded = true;
        
        // 按时间从新到旧排序，取前6条
        const recentLogs = logs.sort((a, b) => b.TIME - a.TIME).slice(0, 6);
        
        const container = document.getElementById('logsContainer');
        if (recentLogs.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">暂无日志记录</div>';
            return;
        }
        
        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="border-bottom: 2px solid #e5e7eb;"><th style="text-align: left; padding: 10px; font-weight: 600;">时间 (UTC+8)</th><th style="text-align: left; padding: 10px; font-weight: 600;">IP</th><th style="text-align: left; padding: 10px; font-weight: 600;">地区</th><th style="text-align: left; padding: 10px; font-weight: 600;">操作</th></tr></thead>';
        html += '<tbody>';
        
        recentLogs.forEach(log => {
            const logType = translateLogType(log.TYPE, log.UA);
            const cc = log.CC || '未知';
            const timeStr = formatTime(log.TIME);
            const ip = log.IP || '未知';
            
            html += `<tr style="border-bottom: 1px solid #f3f4f6;"><td style="padding: 10px;">${timeStr}</td><td style="padding: 10px; font-family: monospace; font-size: 12px;">${ip}</td><td style="padding: 10px;">${cc}</td><td style="padding: 10px;"><span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; color: #fff; background-color: ${logType.color};">${logType.text}</span></td></tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    } catch (error) {
        const container = document.getElementById('logsContainer');
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">加载日志失败: ${error.message}</div>`;
    }
}

// 显示全部日志
async function showAllLogs() {
    try {
        const response = await fetch('/admin/log.json?t=' + Date.now());
        if (!response.ok) throw new Error('加载日志失败');
        const logs = await response.json();
        
        // 按时间从新到旧排序
        const sortedLogs = logs.sort((a, b) => b.TIME - a.TIME);
        
        const container = document.getElementById('allLogsContainer');
        let html = '<table style="width: 100%; border-collapse: collapse; font-size: 12px; table-layout: auto;">';
        html += '<thead><tr style="border-bottom: 2px solid #e5e7eb; background: #f9fafb; white-space: nowrap;"><th style="text-align: left; padding: 10px; font-weight: 600; width: 160px;">时间 (UTC+8)</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 120px;">IP</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 80px;">地区</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 80px;">ASN</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 150px;">操作</th><th style="text-align: left; padding: 10px; font-weight: 600; flex: 1; min-width: 300px;">URL</th><th style="text-align: left; padding: 10px; font-weight: 600; flex: 1; min-width: 200px;">UA</th></tr></thead>';
        html += '<tbody>';
        
        sortedLogs.forEach(log => {
            const logType = translateLogType(log.TYPE, log.UA);
            const cc = log.CC || '未知';
            const asn = log.ASN || '未知';
            const timeStr = formatTime(log.TIME);
            const ip = log.IP || '未知';
            const url = log.URL || '无';
            const ua = log.UA ? log.UA.substring(0, 60) : '无';
            
            html += `<tr style="border-bottom: 1px solid #f3f4f6;"><td style="padding: 8px; white-space: nowrap; width: 160px; font-size: 11px;">${timeStr}</td><td style="padding: 8px; font-family: monospace; font-size: 10px; white-space: nowrap; width: 120px; word-break: break-word;">${ip}</td><td style="padding: 8px; white-space: nowrap; width: 80px; font-size: 11px;">${cc}</td><td style="padding: 8px; white-space: nowrap; width: 80px; font-size: 11px; font-family: monospace;">${asn}</td><td style="padding: 8px; width: 150px;"><span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #fff; background-color: ${logType.color}; white-space: nowrap;">${logType.text}</span></td><td style="padding: 8px; font-size: 11px; word-break: break-word; min-width: 300px;">${url}</td><td style="padding: 8px; font-size: 10px; color: #6b7280; min-width: 200px; word-break: break-word;">${ua}</td></tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        document.getElementById('logsModal').classList.add('show');
    } catch (error) {
        showToast('加载日志失败: ' + error.message, 'error');
    }
}

// 关闭日志模态框
function closeLogsModal(event) {
    if (event && event.target.id !== 'logsModal') return;
    document.getElementById('logsModal').classList.remove('show');
}

function openSubAPIModal() {
    const currentValue = document.getElementById('subAPI').value;
    document.getElementById('testSubAPIInput').value = currentValue;
    document.getElementById('subAPIStatus').style.display = 'none';
    document.getElementById('subAPIStatus').textContent = '';
    document.getElementById('subAPIConfirmBtn').disabled = true;
    document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
    document.getElementById('subAPIModal').classList.add('show');
}

function closeSubAPIModal(event) {
    if (event && event.target.id !== 'subAPIModal') return;
    document.getElementById('subAPIModal').classList.remove('show');
    document.getElementById('testSubAPIInput').value = '';
    document.getElementById('subAPIStatus').style.display = 'none';
}

function normalizeSubAPIURL(url) {
    url = url.trim();
    if (!url) return null;
    
    let parsedURL;
    
    if (!url.includes('://')) {
        url = 'https://' + url;
    }
    
    try {
        parsedURL = new URL(url);
    } catch (e) {
        return null;
    }
    
    const baseURL = parsedURL.origin;
    return baseURL;
}

async function testSubAPI() {
    const input = document.getElementById('testSubAPIInput').value.trim();
    if (!input) {
        showStatus('请输入地址', 'error');
        return;
    }
    
    const baseURL = normalizeSubAPIURL(input);
    if (!baseURL) {
        showStatus('地址格式无效', 'error');
        return;
    }
    
    const testURL = baseURL + '/version';
    const statusEl = document.getElementById('subAPIStatus');
    const buttons = document.querySelectorAll('#subAPIModal button.btn');
    const testBtn = buttons[0];
    
    try {
        testBtn.disabled = true;
        statusEl.textContent = '⏳ 检测中...';
        statusEl.style.display = 'block';
        statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
        statusEl.style.color = '#fff';
        
        const response = await fetch(testURL, {
            method: 'GET'
        });
        
        if (response.status === 200) {
            const content = await response.text();
            const lowerContent = content.toLowerCase();
            
            if (lowerContent.includes('subconverter')) {
                statusEl.style.background = 'linear-gradient(135deg, #10b981 0, #059669 100%)';
                statusEl.textContent = '✅ ' + content;
                document.getElementById('subAPIConfirmBtn').disabled = false;
                document.getElementById('subAPIConfirmBtn').style.opacity = '1';
                document.getElementById('subAPIConfirmBtn').dataset.validURL = baseURL;
            } else {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                statusEl.textContent = '❌ 响应内容无效';
                document.getElementById('subAPIConfirmBtn').disabled = true;
                document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
            }
        } else {
            statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
            statusEl.textContent = '❌ 请求失败 (HTTP ' + response.status + ')';
            document.getElementById('subAPIConfirmBtn').disabled = true;
            document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
        }
    } catch (error) {
        statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
        statusEl.textContent = '❌ 检测失败: ' + error.message;
        document.getElementById('subAPIConfirmBtn').disabled = true;
        document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
    } finally {
        testBtn.disabled = false;
    }
}

function showStatus(message, type) {
    const statusEl = document.getElementById('subAPIStatus');
    const prefix = type === 'error' ? '❌' : 'ℹ️';
    statusEl.textContent = prefix + ' ' + message;
    statusEl.style.display = 'block';
    if (type === 'error') {
        statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
    } else {
        statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
    }
    statusEl.style.color = '#fff';
}

function confirmSubAPI() {
    const validURL = document.getElementById('subAPIConfirmBtn').dataset.validURL;
    if (!validURL) return;
    
    document.getElementById('subAPI').value = validURL;
    markModified('convert');
    closeSubAPIModal();
}

// 初始化
initializeTheme();
window.addEventListener('DOMContentLoaded', loadConfig);
</script>
</body>
</html>